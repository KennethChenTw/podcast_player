# 工作日誌 - 2025年7月29日 (續)

## 任務概述
從 `worklog_20250729_1.md` 之後，主要任務是修正播客播放程式的現有問題，並根據使用者回饋新增功能。

## 解決的問題與實作的功能

### 1. 播放清單行為修正
*   **點擊單集時加入播放清單後面，清單繼續依序播放**：
    *   修改 `src/podcast_player/ui/event_handlers.py` 中的 `handle_episode_double_click` 方法。現在，如果音訊正在播放，新點擊的單集會被加入播放清單末尾，並顯示狀態訊息；如果沒有播放，則會立即播放新點擊的單集。
*   **切換電台時不清空播放清單**：
    *   修改 `src/podcast_player/ui/event_handlers.py` 中的 `handle_rss_success` 方法，移除了 `self.playlist_manager.clear_playlist()` 的呼叫。

### 2. 匯入/匯出電台功能
*   **匯入電台與匯出電台功能**：
    *   修改 `src/podcast_player/ui/main_window.py`，在「檔案」選單中新增了「匯入電台」和「匯出電台」的選項，並將其綁定到 `self.import_stations` 和 `self.export_stations` 方法。
    *   同時修正了「匯入播放清單」和「匯出播放清單」的綁定，使其呼叫 `event_handlers` 中正確的 `handle_import_playlist` 和 `handle_export_playlist`。

### 3. 程式啟動時播放清單是上次關閉時的存檔
*   **實現啟動時載入上次播放清單**：
    *   修改 `src/podcast_player/core/playlist_manager.py`，在 `__init__` 中新增 `playlist_file` 參數，並實作 `save_playlist()` 和 `load_playlist()` 方法來儲存和載入當前播放清單。
    *   修改 `src/podcast_player/main.py`，在 `PodcastPlayerApp.__init__` 中為 `PlaylistManager` 傳入 `playlist_file` 路徑 (`data/current_playlist.json`)。
    *   在 `PodcastPlayerApp.save_current_state` 中呼叫 `self.playlist_manager.save_playlist()`。
    *   在 `PodcastPlayerApp.apply_restored_state` 中，呼叫 `self.ui.populate_playlist` 來顯示載入的播放清單。

### 4. 偏好設定：載入單集數量
*   **新增偏好設定選項**：
    *   修改 `src/podcast_player/core/config_manager.py`，在 `defaults` 中新增 `episode_load_mode` ('all' 或 'latest') 和 `latest_episode_count` (預設 10)。
    *   修改 `src/podcast_player/core/rss_processor.py`，在 `fetch_podcast` 方法中根據 `config_manager` 的設定來篩選載入的單集數量。
    *   修改 `src/podcast_player/main.py`，在初始化 `RSSProcessor` 時傳入 `config_manager`。
    *   修改 `src/podcast_player/ui/main_window.py`，實作 `show_preferences` 方法，創建一個偏好設定視窗，允許使用者選擇載入模式和數量。

### 5. 重新整理功能
*   **實作重新整理功能**：
    *   在 `src/podcast_player/ui/event_handlers.py` 中新增 `handle_refresh` 方法，使其呼叫 `handle_fetch_podcast` 來重新抓取 RSS feed。
    *   修改 `src/podcast_player/ui/main_window.py` 中的 `refresh_view` 方法，使其呼叫 `event_handlers.handle_refresh`。
    *   在 `src/podcast_player/main.py` 的 `apply_restored_state` 中，將自動抓取 RSS 的呼叫從直接呼叫改為 `self.root.after(500, self.event_handlers.handle_fetch_podcast)`，以延遲執行，確保 UI 準備就緒。

### 6. 可拖曳進度條與速度按鈕
*   **更換音訊引擎為 `python-vlc`**：
    *   修改 `requirements.txt`，將 `just_playback` 替換為 `python-vlc`。
    *   **重要提示**：使用者需手動安裝 `python-vlc` 函式庫 (`pip install python-vlc`) 和 VLC 媒體播放器本身。
    *   重構 `src/podcast_player/core/audio_player.py`：
        *   完全移除 `pygame.mixer` 相關程式碼，改用 `vlc` 模組。
        *   實現 `seek(position)` 方法，利用 `vlc.MediaPlayer.set_time()` 實現精確跳轉。
        *   重新啟用並實作變速播放功能，利用 `vlc.MediaPlayer.set_rate()`。
        *   修改進度追蹤邏輯，直接從 `vlc.MediaPlayer` 獲取 `get_time()` 和 `get_length()` 以提供準確的進度。
        *   在 `_play_worker` 中增加延遲和日誌，以確保 VLC 播放器有足夠時間啟動。
    *   修改 `src/podcast_player/ui/components.py`：將進度條從 `ttk.Progressbar` 替換為 `ttk.Scale`，並設定其 `from_`、`to` 和 `command` 屬性。
    *   修改 `src/podcast_player/ui/event_handlers.py`：新增 `handle_seek_position` 方法來處理 `Scale` 的拖曳事件，並更新 `handle_progress_update` 以適應 `Scale`。
    *   修改 `src/podcast_player/ui/main_window.py`：重新啟用速度按鈕並綁定其回呼。

### 7. 解決 Pylance 錯誤與運行時錯誤
*   **Pylance 類型提示問題**：
    *   `src/podcast_player/core/logger.py`：修正 `log_user_action` 為 `log_action`，並處理 `Path` 物件在 `open()` 中的類型轉換問題。
    *   `src/podcast_player/core/rss_processor.py`：將 `feedparser` 和 `requests` 的匯入移到檔案頂部，解決 `None` 屬性問題。
    *   `src/podcast_player/core/audio_player.py`：將 `vlc` 的匯入移到檔案頂部，並修正 `toggle_play` 的回傳類型。
    *   `src/podcast_player/main.py`：為 `rss_entry` 變數添加 `isinstance(rss_entry, tk.Entry)` 檢查，並處理 `os.path.join` 和 `os.path.abspath` 的類型提示問題。
    *   `src/podcast_player/ui/main_window.py`：為 `config_manager` 和 `search_entry` 變數添加類型檢查，並修正 `handle_volume_changed` 參數的類型轉換。
    *   `src/podcast_player/ui/theme_manager.py`：在 `apply_theme_to_application` 和 `_apply_theme_recursively` 中增加 `winfo_exists()` 和 `isinstance(widget, tk.Widget)` 檢查，並為 `ThemeManager` 添加 `root` 屬性。
*   **`application has been destroyed` 運行時錯誤**：
    *   在 `src/podcast_player/main.py` 的 `on_closing` 方法中，在 `self.root.destroy()` 之前，將 `self.main_window.theme_manager.root` 設為 `None`，以防止在視窗銷毀後觸發主題相關事件。
*   **VLC 串流錯誤與「按播放會直接跳到播放完畢」問題**：
    *   在 `src/podcast_player/core/audio_player.py` 的 `_play_worker` 中，增加了播放啟動後的延遲和狀態檢查，並在播放請求被取代時明確停止 VLC 播放器。

## 修改的檔案列表
*   `requirements.txt`
*   `src/podcast_player/core/audio_player.py`
*   `src/podcast_player/core/config_manager.py`
*   `src/podcast_player/core/logger.py`
*   `src/podcast_player/core/playlist_manager.py`
*   `src/podcast_player/core/rss_processor.py`
*   `src/podcast_player/main.py`
*   `src/podcast_player/ui/components.py`
*   `src/podcast_player/ui/event_handlers.py`
*   `src/podcast_player/ui/main_window.py`
*   `src/podcast_player/ui/theme_manager.py`

## 遇到的挑戰和解決方案
1.  **虛擬環境 `pip` 路徑問題**：在 Windows 環境下，直接執行虛擬環境中的 `pip.exe` 或 `python.exe` 遇到路徑問題。最終由使用者手動安裝依賴解決。
2.  **`just_playback` 函式庫問題**：最初選擇的 `just_playback` 函式庫在實際使用中發現其 `load()` 和 `play()` 方法行為與預期不符，且無法實現進度條拖曳。最終決定更換為 `python-vlc`。
3.  **`python-vlc` 整合挑戰**：
    *   需要使用者手動安裝 VLC 媒體播放器本身。
    *   VLC 播放器在啟動時需要短暫延遲才能進入播放狀態，否則 `is_playing()` 會立即回傳 `False`，導致「播放完畢」的假象。通過增加延遲和日誌來診斷和解決。
4.  **Tkinter 應用程式關閉時序問題 (`application has been destroyed`)**：
    *   在應用程式關閉時，Tkinter 視窗被銷毀後，主題管理器或其他背景任務仍在嘗試操作 UI 元件，導致錯誤。
    *   解決方案包括在 `theme_manager` 中增加 `winfo_exists()` 檢查，並在 `main.py` 的 `on_closing` 中，在銷毀視窗前明確地斷開 `theme_manager` 對 `root` 的引用。
5.  **Pylance 類型提示問題**：
    *   由於 Tkinter 和某些第三方庫的動態特性，Pylance 報告了許多類型提示錯誤。這些錯誤通過添加 `isinstance` 檢查、調整匯入方式和修正方法簽名來解決，以提高程式碼的健壯性和可讀性。
